---
import { Image } from "astro:assets";
import { useTranslations } from "../i18n/utils";

import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

interface Props {
  lang: string;
}

const { lang } = Astro.props;
const t = useTranslations(lang as any);

const allEvents = await getCollection("events");
const sortedEvents = allEvents
  .filter((event: CollectionEntry<"events">) => event.data.isPublished)
  .sort(
    (a: CollectionEntry<"events">, b: CollectionEntry<"events">) =>
      b.data.date.getTime() - a.data.date.getTime(),
  );
---

<section id="events" class="py-24 bg-stone-50">
  <div class="container mx-auto px-4 max-w-7xl">
    <div class="text-center mb-16">
      <h2
        class="text-4xl md:text-6xl font-serif italic text-coastal-stone-deep mb-4"
      >
        {t("events.title") || "Workshops & Eventos"}
      </h2>
      <p class="text-xs uppercase tracking-[0.4em] text-stone-400 font-sans">
        {t("events.subtitle") || "DESCUBRE LAS PRÓXIMAS FECHAS"}
      </p>
    </div>

    {
      sortedEvents.length === 0 ? (
        <p class="text-center text-stone-500 italic py-10">
          No hay eventos próximos por el momento.
        </p>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {sortedEvents.map(async (event) => {
            const { Content } = await event.render();

            return (
              <article class="bg-white rounded-sm shadow-sm hover:shadow-md transition-shadow duration-300 overflow-hidden group">
                <div class="aspect-[4/3] w-full overflow-hidden relative bg-stone-100">
                  <Image
                    src={
                      event.data.coverImage ||
                      "https://placehold.co/600x450?text=Workshop"
                    }
                    alt={event.data.title}
                    width={600}
                    height={450}
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                  />
                </div>
                <div class="p-8">
                  <time class="text-xs font-sans tracking-widest text-coastal-blue-light uppercase mb-3 block">
                    {event.data.date.toLocaleDateString(
                      lang === "es" ? "es-ES" : "en-US",
                      { year: "numeric", month: "long", day: "numeric" },
                    )}
                  </time>
                  <h3 class="text-2xl font-serif text-stone-800 mb-4">
                    {event.data.title}
                  </h3>

                  <div class="prose prose-sm prose-stone mb-6 font-sans text-stone-600 line-clamp-3">
                    <Content />
                  </div>

                  {event.data.paymentLink && (
                    <a
                      href={event.data.paymentLink}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center text-xs tracking-widest uppercase border-b border-coastal-blue-light text-coastal-blue-deep hover:text-coastal-blue-light transition-colors pb-1"
                    >
                      {t("events.cta") || "+info"}
                    </a>
                  )}
                </div>
              </article>
            );
          })}
        </div>
      )
    }
  </div>
</section>
